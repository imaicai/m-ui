<!DOCTYPE html>
<html lang="en">
{{template "head" .}}
<style>
    /* 布局样式 */
    @media (min-width: 769px) {
        .ant-layout-content {
            margin: var(--space-4) var(--space-4);
        }
    }

    /* 卡片样式 */
    .status-card {
        border-radius: var(--radius-md) !important;
        border: none !important;
        box-shadow: var(--shadow-sm) !important;
        transition: all var(--transition-normal) var(--easing-standard) !important;
        margin-bottom: var(--space-4);
        overflow: hidden;
        position: relative;
    }

    .status-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background-color: var(--primary);
    }

    .status-card:hover {
        box-shadow: var(--shadow-md) !important;
        transform: translateY(-2px);
    }

    /* 资源卡片 */
    .resource-card {
        border-radius: var(--radius-md) !important;
        border: none !important;
        box-shadow: var(--shadow-sm) !important;
        transition: all var(--transition-normal) var(--easing-standard) !important;
        margin-bottom: var(--space-4);
        overflow: hidden;
    }

    .resource-card:hover {
        box-shadow: var(--shadow-md) !important;
    }

    /* 仪表盘进度条 */
    .dashboard-progress {
        margin-bottom: var(--space-2);
    }

    .dashboard-progress .ant-progress-inner {
        width: 120px !important;
        height: 120px !important;
    }

    .dashboard-progress .ant-progress-text {
        font-family: var(--font-family-heading);
        font-weight: var(--font-semibold);
        font-size: var(--text-xl);
        color: var(--text-primary);
    }

    /* 状态标签 */
    .status-tag {
        border-radius: var(--radius-full) !important;
        border: none !important;
        padding: 0 var(--space-2) !important;
        font-weight: var(--font-medium) !important;
        line-height: 1.8 !important;
        margin-right: var(--space-2) !important;
    }

    /* 网格布局 */
    .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-4);
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
        .status-grid {
            grid-template-columns: 1fr;
        }
        
        .ant-col-sm-24 {
            margin-top: var(--space-2);
        }
    }
</style>
<body>
<a-layout id="app" v-cloak>
    {{ template "commonSider" . }}
    <a-layout id="content-layout">
        <a-layout-content>
            <a-spin :spinning="spinning" :delay="200" :tip="loadingTip"/>
            <transition name="fade-in" appear>
                <div class="status-grid">
                    <!-- CPU 使用率 -->
                    <a-card class="resource-card">
                        <div class="dashboard-progress">
                            <a-progress type="dashboard" 
                                       :percent="status.cpu.percent"
                                       :stroke-color="status.cpu.color"
                                       :format="percent => `${percent}%`">
                            </a-progress>
                        </div>
                        <div class="text-center">
                            <h3>CPU 使用率</h3>
                            <p class="text-secondary">[[ status.cpu.percent ]]%</p>
                        </div>
                    </a-card>

                    <!-- 内存使用 -->
                    <a-card class="resource-card">
                        <div class="dashboard-progress">
                            <a-progress type="dashboard" 
                                       :percent="status.mem.percent"
                                       :stroke-color="status.mem.color"
                                       :format="percent => `${percent}%`">
                            </a-progress>
                        </div>
                        <div class="text-center">
                            <h3>内存使用</h3>
                            <p class="text-secondary">
                                [[ sizeFormat(status.mem.current) ]] / [[ sizeFormat(status.mem.total) ]]
                            </p>
                        </div>
                    </a-card>

                    <!-- 交换空间 -->
                    <a-card class="resource-card">
                        <div class="dashboard-progress">
                            <a-progress type="dashboard" 
                                       :percent="status.swap.percent"
                                       :stroke-color="status.swap.color"
                                       :format="percent => `${percent}%`">
                            </a-progress>
                        </div>
                        <div class="text-center">
                            <h3>交换空间</h3>
                            <p class="text-secondary">
                                [[ sizeFormat(status.swap.current) ]] / [[ sizeFormat(status.swap.total) ]]
                            </p>
                        </div>
                    </a-card>

                    <!-- 硬盘使用 -->
                    <a-card class="resource-card">
                        <div class="dashboard-progress">
                            <a-progress type="dashboard" 
                                       :percent="status.disk.percent"
                                       :stroke-color="status.disk.color"
                                       :format="percent => `${percent}%`">
                            </a-progress>
                        </div>
                        <div class="text-center">
                            <h3>硬盘使用</h3>
                            <p class="text-secondary">
                                [[ sizeFormat(status.disk.current) ]] / [[ sizeFormat(status.disk.total) ]]
                            </p>
                        </div>
                    </a-card>
                </div>
            </transition>
            <transition name="fade-in" appear>
                <div class="status-grid">
                    <!-- Xray 状态 -->
                    <a-card class="status-card">
                        <h3>Xray 状态</h3>
                        <div class="status-info">
                            <a-tag class="status-tag" :style="{backgroundColor: status.xray.color + '20', color: status.xray.color}">
                                [[ status.xray.state ]]
                            </a-tag>
                            <a-tooltip v-if="status.xray.state === State.Error">
                                <template slot="title">
                                    <p v-for="line in status.xray.errorMsg.split('\n')">[[ line ]]</p>
                                </template>
                                <a-icon type="question-circle" theme="filled"></a-icon>
                            </a-tooltip>
                            <div class="mt-2">
                                <a-tag class="status-tag" style="background-color: var(--success-20); color: var(--success);" 
                                       @click="openSelectV2rayVersion">
                                    [[ status.xray.version ]]
                                </a-tag>
                                <a-tag class="status-tag" style="background-color: var(--primary-20); color: var(--primary);" 
                                       @click="openSelectV2rayVersion">
                                    切换版本
                                </a-tag>
                            </div>
                        </div>
                    </a-card>

                    <!-- 运行时间 -->
                    <a-card class="status-card">
                        <h3>运行时间</h3>
                        <div class="status-info">
                            <a-tag class="status-tag" style="background-color: var(--success-20); color: var(--success);">
                                [[ formatSecond(status.uptime) ]]
                            </a-tag>
                            <a-tooltip>
                                <template slot="title">
                                    系统自启动以来的运行时间
                                </template>
                                <a-icon type="question-circle" theme="filled"></a-icon>
                            </a-tooltip>
                        </div>
                    </a-card>

                    <!-- 系统负载 -->
                    <a-card class="status-card">
                        <h3>系统负载</h3>
                        <div class="status-info">
                            <div class="load-indicator">
                                <div class="load-value">[[ status.loads[0] ]]</div>
                                <div class="load-value">[[ status.loads[1] ]]</div>
                                <div class="load-value">[[ status.loads[2] ]]</div>
                            </div>
                        </div>
                    </a-card>

                    <!-- 网络连接数 -->
                    <a-card class="status-card">
                        <h3>网络连接数</h3>
                        <div class="status-info">
                            <div class="connection-count">
                                <div>
                                    <span class="connection-label">TCP:</span>
                                    <span class="connection-value">[[ status.tcpCount ]]</span>
                                </div>
                                <div>
                                    <span class="connection-label">UDP:</span>
                                    <span class="connection-value">[[ status.udpCount ]]</span>
                                </div>
                            </div>
                            <a-tooltip>
                                <template slot="title">
                                    所有网卡的总连接数
                                </template>
                                <a-icon type="question-circle" theme="filled"></a-icon>
                            </a-tooltip>
                        </div>
                    </a-card>

                    <!-- 网络速度 -->
                    <a-card class="status-card">
                        <h3>网络速度</h3>
                        <div class="status-info">
                            <div class="network-speed">
                                <div>
                                    <a-icon type="arrow-up" style="color: var(--primary);"/>
                                    <span class="speed-value">[[ sizeFormat(status.netIO.up) ]] / S</span>
                                </div>
                                <div>
                                    <a-icon type="arrow-down" style="color: var(--accent);"/>
                                    <span class="speed-value">[[ sizeFormat(status.netIO.down) ]] / S</span>
                                </div>
                            </div>
                            <a-tooltip>
                                <template slot="title">
                                    所有网卡的总上传/下载速度
                                </template>
                                <a-icon type="question-circle" theme="filled"></a-icon>
                            </a-tooltip>
                        </div>
                    </a-card>

                    <!-- 网络流量 -->
                    <a-card class="status-card">
                        <h3>网络流量</h3>
                        <div class="status-info">
                            <div class="network-traffic">
                                <div>
                                    <a-icon type="cloud-upload" style="color: var(--primary);"/>
                                    <span class="traffic-value">[[ sizeFormat(status.netTraffic.sent) ]]</span>
                                </div>
                                <div>
                                    <a-icon type="cloud-download" style="color: var(--accent);"/>
                                    <span class="traffic-value">[[ sizeFormat(status.netTraffic.recv) ]]</span>
                                </div>
                            </div>
                            <a-tooltip>
                                <template slot="title">
                                    系统启动以来所有网卡的总上传/下载流量
                                </template>
                                <a-icon type="question-circle" theme="filled"></a-icon>
                            </a-tooltip>
                        </div>
                    </a-card>
                </div>
            </transition>
        </a-layout-content>
    </a-layout>
    <a-modal id="version-modal" v-model="versionModal.visible" title="切换版本"
             :closable="true" @ok="() => versionModal.visible = false"
             ok-text="确定" cancel-text="取消">
        <h2>点击你想切换的版本</h2>
        <h2>请谨慎选择，旧版本可能配置不兼容</h2>
        <template v-for="version, index in versionModal.versions">
            <a-tag :color="index % 2 == 0 ? 'blue' : 'green'"
                   style="margin: 10px" @click="switchV2rayVersion(version)">
                [[ version ]]
            </a-tag>
        </template>
    </a-modal>
</a-layout>
{{template "js" .}}
<script>

    const State = {
        Running: "running",
        Stop: "stop",
        Error: "error",
    }
    Object.freeze(State);

    class CurTotal {

        constructor(current, total) {
            this.current = current;
            this.total = total;
        }

        get percent() {
            if (this.total === 0) {
                return 0;
            }
            return toFixed(this.current / this.total * 100, 2);
        }

        get color() {
            const percent = this.percent;
            if (percent < 80) {
                return '#67C23A';
            } else if (percent < 90) {
                return '#E6A23C';
            } else {
                return '#F56C6C';
            }
        }
    }

    class Status {
        constructor(data) {
            this.cpu = new CurTotal(0, 0);
            this.disk = new CurTotal(0, 0);
            this.loads = [0, 0, 0];
            this.mem = new CurTotal(0, 0);
            this.netIO = {up: 0, down: 0};
            this.netTraffic = {sent: 0, recv: 0};
            this.swap = new CurTotal(0, 0);
            this.tcpCount = 0;
            this.udpCount = 0;
            this.uptime = 0;
            this.xray = {state: State.Stop, errorMsg: "", version: "", color: ""};

            if (data == null) {
                return;
            }
            this.cpu = new CurTotal(data.cpu, 100);
            this.disk = new CurTotal(data.disk.current, data.disk.total);
            this.loads = data.loads.map(load => toFixed(load, 2));
            this.mem = new CurTotal(data.mem.current, data.mem.total);
            this.netIO = data.netIO;
            this.netTraffic = data.netTraffic;
            this.swap = new CurTotal(data.swap.current, data.swap.total);
            this.tcpCount = data.tcpCount;
            this.udpCount = data.udpCount;
            this.uptime = data.uptime;
            this.xray = data.xray;
            switch (this.xray.state) {
                case State.Running:
                    this.xray.color = "green";
                    break;
                case State.Stop:
                    this.xray.color = "orange";
                    break;
                case State.Error:
                    this.xray.color = "red";
                    break;
                default:
                    this.xray.color = "gray";
            }
        }
    }

    const versionModal = {
        visible: false,
        versions: [],
        show(versions) {
            this.visible = true;
            this.versions = versions;
        },
        hide() {
            this.visible = false;
        },
    };

    const app = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app',
        data: {
            siderDrawer,
            status: new Status(),
            versionModal,
            spinning: false,
            loadingTip: '加载中',
        },
        methods: {
            loading(spinning, tip = '加载中') {
                this.spinning = spinning;
                this.loadingTip = tip;
            },
            async getStatus() {
                const msg = await HttpUtil.post('/server/status');
                if (msg.success) {
                    this.setStatus(msg.obj);
                }
            },
            setStatus(data) {
                this.status = new Status(data);
            },
            async openSelectV2rayVersion() {
                this.loading(true);
                const msg = await HttpUtil.post('server/getXrayVersion');
                this.loading(false);
                if (!msg.success) {
                    return;
                }
                versionModal.show(msg.obj);
            },
            switchV2rayVersion(version) {
                this.$confirm({
                    title: '切换 xray 版本',
                    content: '是否切换 xray 版本至' + ` ${version}?`,
                    okText: '确定',
                    cancelText: '取消',
                    onOk: async () => {
                        versionModal.hide();
                        this.loading(true, '安装中，请不要刷新此页面');
                        await HttpUtil.post(`/server/installXray/${version}`);
                        this.loading(false);
                    },
                });
            },
        },
        async mounted() {
            while (true) {
                try {
                    await this.getStatus();
                } catch (e) {
                    console.error(e);
                }
                await PromiseUtil.sleep(2000);
            }
        },
    });

</script>
</body>
</html>